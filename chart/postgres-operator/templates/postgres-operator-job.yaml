apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "postgres-operator.fullname" . }}
  labels:
    app.kubernetes.io/name: {{ include "postgres-operator.name" . }}
    helm.sh/chart: {{ include "postgres-operator.chart" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
  annotations:
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  template:
    metadata:
      name: {{ include "postgres-operator.fullname" . }}
      labels:
        app.kubernetes.io/name: {{ include "postgres-operator.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      containers:
        - name: {{ .Chart.Name }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          volumeMounts:
            - name: postgres-operator-yaml
              mountPath: /home/default/operator/deploy/configmap-yaml
            - name: postgres-operator-conf-yaml
              mountPath: /home/default/operator/conf/postgres-operator/configmap-yaml
            - name: kubeconfig
              mountPath: /kubeconfig
          env:
            - name: RUN_TIME
              value: {{ .Values.runTime | quote }}
            - name: KUBERNETES_NAMESPACE
              value: "pgo"
            - name: BASE_KUBERNETES_NAMESPACE
              value: "pgo"
            - name: BASE_KUBERNETES_NAMESPACE_SERVICE_ACCOUNT
              value: "pgo"
            - name: BASE_KUBERNETES_NAMESPACE_SERVICE_ACCOUNT_TOKEN
              value: "eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJwZ28iLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlY3JldC5uYW1lIjoicGdvLXRva2VuLXpqNTV2Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6InBnbyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjJiMDBlYmQyLTcyODktMTFlYS1hMjlmLTQyMDEwYTgwMDFmNSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpwZ286cGdvIn0.Bc26AL98asQW3xpLvuwOpdx82k3NuxciWNyYw_pZlx0-D_v5GwHjU-AjCXDFVAbqaxsCFkCs5q7acfvA9e0Nc20VzX9hrt5uq9dYfdmut8cN4VdJu3QNcnzjM-7ppcJJFUfGM2M0aixTZrRRYPABk4eOKCnwo4UBa8GjLviv44PlXLwwVLHBgBQyiOmBLjkU5kgrsQfzwZQ3njwm43QrZR2chbgWAO5TDZE0RE278xa_05Zhkn5qu4iTwEUI3Ej_RB4afVGEWViseGnFrrMUh4rmZfblCE4H8HFdocIW18KCZkNrpEGdmLLwvIzOyjpuCr6Yh65O1eaZk5W5NCbIDw"
            - name: OPERATOR_COMMAND
              value: {{ .Values.command | default "deploy" | quote }}
            - name: OPERATOR_IMAGES
              value: {{ .Values.image.repository | quote }}
            - name: OPERATOR_POD
              value: {{ .Values.podName | default "postgres-operator" | quote }}
            - name: OPERATOR_CLIENT_POD
              value: {{ .Values.podName | default "pgo-client" | quote }}
            - name: BACKUP_TYPE
              value: {{ .Values.backupType | default "FULL" | quote }}
            - name: CLUSTER_NAME
              value: {{ .Values.clusterName | quote }}
            - name: PGOADMIN_USERNAME
              value: {{ .Values.perconaOperatorVersion | default "pgoadmin" | quote }}
            - name: PGOADMIN_PASSWORD
              value: {{ .Values.perconaApiVersion | default "pgoadmin" | quote }}
            - name: PGOADMIN_PERMS
              value: {{ .Values.perconaOperatorVersion | default "*" | quote }}
            - name: PGO_INSTALLATION_NAME
              value: {{ .Values.perconaApiVersion | default "dev" | quote }}
            - name: PGO_IMAGE_PREFIX
              value: {{ .Values.perconaOperatorVersion | default "crunchydata" | quote }}
            - name: PGO_BASEOS
              value: {{ .Values.perconaApiVersion | default "centos7" | quote }}
            - name: PGO_VERSION
              value: {{ .Values.perconaApiVersion | default "4.2.1" | quote }}
            - name: PGO_APISERVER_PORT
              value: {{ .Values.perconaApiVersion | default "8443" | quote }}
            - name: DISABLE_TLS
              value: {{ .Values.perconaApiVersion | default false | quote }}
            - name: TLS_NO_VERIFY
              value: {{ .Values.perconaApiVersion | default false | quote }}
            - name: TLS_CA_TRUST
              value: {{ .Values.perconaApiVersion | default "" | quote }}
            - name: ADD_OS_TRUSTSTORE
              value: {{ .Values.perconaApiVersion | default false| quote }}
            - name: NOAUTH_ROUTES
              value: {{ .Values.perconaApiVersion | default "" | quote }}
            - name: EXCLUDE_OS_TRUST
              value: {{ .Values.perconaApiVersion | default false | quote }}
            - name: DISABLE_EVENTING
              value: {{ .Values.perconaApiVersion | default false | quote }}
      volumes:
        - name: postgres-operator-yaml
          configMap:
            name: {{ include "postgres-operator.fullname" . }}
        - name: postgres-operator-conf-yaml
          configMap:
            name: {{ include "postgres-operator.fullname" . }}-conf
        - name: kubeconfig
          configMap:
            name: {{ include "postgres-operator.fullname" . }}-kubeconfig
      restartPolicy: Never
